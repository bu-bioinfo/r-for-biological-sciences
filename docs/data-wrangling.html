<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Data Wrangling | BF591 - R for Biological Sciences</title>
<meta name="generator" content="bookdown 0.32 with bs4_book()">
<meta property="og:title" content="5 Data Wrangling | BF591 - R for Biological Sciences">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5 Data Wrangling | BF591 - R for Biological Sciences">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
<meta name="description" content="5.1 The Tidyverse The tidyverse is “an opinionated collection of R packages designed for data science.” The packages are all designed to work together with a unified approach that helps code look...">
<meta property="og:description" content="5.1 The Tidyverse The tidyverse is “an opinionated collection of R packages designed for data science.” The packages are all designed to work together with a unified approach that helps code look...">
<meta name="twitter:description" content="5.1 The Tidyverse The tidyverse is “an opinionated collection of R packages designed for data science.” The packages are all designed to work together with a unified approach that helps code look...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">BF591 - R for Biological Sciences</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">R for Biological Sciences</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="data-bio.html"><span class="header-section-number">2</span> Data in Biology</a></li>
<li><a class="" href="preliminaries.html"><span class="header-section-number">3</span> Preliminaries</a></li>
<li><a class="" href="prog-basics.html"><span class="header-section-number">4</span> R Programming</a></li>
<li><a class="active" href="data-wrangling.html"><span class="header-section-number">5</span> Data Wrangling</a></li>
<li><a class="" href="data-science.html"><span class="header-section-number">6</span> Data Science</a></li>
<li><a class="" href="data-visualization.html"><span class="header-section-number">7</span> Data Visualization</a></li>
<li><a class="" href="biology-bioinformatics.html"><span class="header-section-number">8</span> Biology &amp; Bioinformatics</a></li>
<li><a class="" href="engineering.html"><span class="header-section-number">9</span> EngineeRing</a></li>
<li><a class="" href="rshiny.html"><span class="header-section-number">10</span> RShiny</a></li>
<li><a class="" href="communicating-with-r.html"><span class="header-section-number">11</span> Communicating with R</a></li>
<li><a class="" href="contribution-guide.html"><span class="header-section-number">12</span> Contribution Guide</a></li>
<li class="book-part">Assignments</li>
<li><a class="" href="starting-an-assignment.html">Starting an Assignment</a></li>
<li><a class="" href="assignment-overview.html">Assignment Overview</a></li>
<li><a class="" href="assignment-0.html">Assignment 0</a></li>
<li><a class="" href="assignment-1.html">Assignment 1</a></li>
<li><a class="" href="assignment-2.html">Assignment 2</a></li>
<li><a class="" href="assignment-3.html">Assignment 3</a></li>
<li><a class="" href="assignment-4.html">Assignment 4</a></li>
<li><a class="" href="assignment-5.html">Assignment 5</a></li>
<li><a class="" href="assignment-6.html">Assignment 6</a></li>
<li><a class="" href="assignment-7.html">Assignment 7</a></li>
<li><a class="" href="final-project.html">Final Project</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="detailed-class-schedule.html"><span class="header-section-number">A</span> Detailed Class Schedule</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="data-wrangling" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Data Wrangling<a class="anchor" aria-label="anchor" href="#data-wrangling"><i class="fas fa-link"></i></a>
</h1>
<div id="the-tidyverse" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> The Tidyverse<a class="anchor" aria-label="anchor" href="#the-tidyverse"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://www.tidyverse.org/">The tidyverse</a> is “an opinionated collection of R
packages designed for data science.” The packages are all designed to work
together with a unified approach that helps code look consistent and neat. In
the opinion of this author, the tidyverse practically changes the R language
from a principally statistical programming language into an efficient and
expressive data science language. While it is still important to understand the
language fundamentals presented in our <a href="prog-basics.html#prog-basics">chapter on the R programming
language</a>, the tidyverse uses a distinct set of coding conventions
that lets it achieve greater expressiveness, conciseness, and correctness
relative to the base R language.</p>
<p>As a data science language, R+tidyverse (referred to as simply <em>tidyverse</em> in
this book) is strongly focused on operations related to loading, manipulating,
visualizing, summarizing, and analyzing data sets from many domains. While this
is a major strength of tidyverse and its community, it means that many
educational materials are written for this general use case, and not for those
practicing biological data analysis. While the general data manipulation
operations are often the same between biological data analysis and these general
case examples, biological analysis practitioners must nonetheless translate
concepts from these general cases to the common data analysis tasks they must
perform. Some analytical patterns are more common in biological data analysis
than others, so these materials focus on that subset of operations in this book
to aid the learning in applying the concepts to their problems as directly as
possible.</p>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/wrangle-intro.html">R for Data Science - Data Wrangling Introduction</a></li>
<li><a href="https://moderndive.com/3-wrangling.html">ModernDive - Data Wrangling</a></li>
</ul>
</div>
</div>
<div id="dw-basics" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Tidyverse Basics<a class="anchor" aria-label="anchor" href="#dw-basics"><i class="fas fa-link"></i></a>
</h2>
<p>Since tidyverse is a set of packages that work together, you will often want to
load multiple packages at the same time. The tidyverse authors recognize this,
and defined a set of reasonable packages to load at once when loading the
metapackage (i.e. a package that contains multiple packages):</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="data-wrangling.html#cb72-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb72-2"><a href="data-wrangling.html#cb72-2" tabindex="-1"></a><span class="sc">--</span> Attaching packages <span class="sc">---------------------------------------------</span> tidyverse <span class="dv">1</span>.<span class="fl">3.1</span> <span class="sc">--</span></span>
<span id="cb72-3"><a href="data-wrangling.html#cb72-3" tabindex="-1"></a>v ggplot2 <span class="dv">3</span>.<span class="fl">3.5</span>     v purrr   <span class="dv">0</span>.<span class="fl">3.4</span></span>
<span id="cb72-4"><a href="data-wrangling.html#cb72-4" tabindex="-1"></a>v tibble  <span class="dv">3</span>.<span class="fl">1.6</span>     v dplyr   <span class="dv">1</span>.<span class="fl">0.7</span></span>
<span id="cb72-5"><a href="data-wrangling.html#cb72-5" tabindex="-1"></a>v tidyr   <span class="dv">1</span>.<span class="fl">1.4</span>     v stringr <span class="dv">1</span>.<span class="fl">4.0</span></span>
<span id="cb72-6"><a href="data-wrangling.html#cb72-6" tabindex="-1"></a>v readr   <span class="dv">2</span>.<span class="fl">1.1</span>     v forcats <span class="dv">0</span>.<span class="fl">5.1</span></span>
<span id="cb72-7"><a href="data-wrangling.html#cb72-7" tabindex="-1"></a><span class="sc">--</span> Conflicts <span class="sc">------------------------------------------------</span> <span class="fu">tidyverse_conflicts</span>() <span class="sc">--</span></span>
<span id="cb72-8"><a href="data-wrangling.html#cb72-8" tabindex="-1"></a>x dplyr<span class="sc">::</span><span class="fu">filter</span>() masks stats<span class="sc">::</span><span class="fu">filter</span>()</span>
<span id="cb72-9"><a href="data-wrangling.html#cb72-9" tabindex="-1"></a>x dplyr<span class="sc">::</span><span class="fu">lag</span>()    masks stats<span class="sc">::</span><span class="fu">lag</span>()</span></code></pre></div>
<p>The packages in the <code>Attaching packages</code> section are those loaded by default,
and each of these packages adds a unique set of functions to your R environment.
We will mention functions from many of these packages as we go through this
chapter, but for now here is a table of these packages and briefly what they do:</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="47%">
<col width="52%">
</colgroup>
<thead><tr class="header">
<th>Package</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><a href="https://ggplot2.tidyverse.org/">ggplot2</a></td>
<td>Plotting using the grammar of graphics</td>
</tr>
<tr class="even">
<td><a href="https://tibble.tidyverse.org/">tibble</a></td>
<td>Simple and sane data frames</td>
</tr>
<tr class="odd">
<td><a href="https://tidyr.tidyverse.org/">tidyr</a></td>
<td>Operations for making data “tidy”</td>
</tr>
<tr class="even">
<td><a href="https://readr.tidyverse.org/">readr</a></td>
<td>Read rectangular text data into tidyverse</td>
</tr>
<tr class="odd">
<td><a href="https://purrr.tidyverse.org/">purrr</a></td>
<td>Functional programming tools for tidyverse</td>
</tr>
<tr class="even">
<td><a href="https://dplyr.tidyverse.org/">dplyr</a></td>
<td>“A Grammar of Data Manipulation”</td>
</tr>
<tr class="odd">
<td><a href="https://stringr.tidyverse.org/">stringr</a></td>
<td>Makes working with strings in R easier</td>
</tr>
<tr class="even">
<td><a href="https://forcats.tidyverse.org/">forcats</a></td>
<td>Operations for using categorical variables</td>
</tr>
</tbody>
</table></div>
<div class="box note">
<p>Notice the <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> syntax in the <code>Conflicts</code> section. <code>filter</code> is
defined as a function in both the <code>dplyr</code> package as well as the base R <code>stats</code>
package. The <code>stats</code> package is loaded by default when you run R, and thus the
<code>filter</code> function is defined (specifically, it performs <a href="https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/filter">linear filtering on
time series
data</a>).
However, when <code>dplyr</code> is loaded, it also has a <code>filter</code> function which overrides
the definition from the <code>stats</code> package. This is why the tidyverse package
reports this as a conflict when loaded:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="data-wrangling.html#cb73-1" tabindex="-1"></a><span class="sc">--</span> Conflicts <span class="sc">------------------------------------------------</span> <span class="fu">tidyverse_conflicts</span>() <span class="sc">--</span></span>
<span id="cb73-2"><a href="data-wrangling.html#cb73-2" tabindex="-1"></a>x dplyr<span class="sc">::</span><span class="fu">filter</span>() masks stats<span class="sc">::</span><span class="fu">filter</span>()</span></code></pre></div>
<p>This is tidyverse telling you that the <code>filter</code> function has been redefined and
you should make sure you are aware of that.</p>
<p>However, if you did want to use the original <code>stats</code> defined <code>filter</code> function,
you may still access it using the <code>::</code> namespace operator. This operator lets
you “look inside” a loaded package, for example <code>dplyr</code>, and access a function
within the namespace of that package:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="co"># the filter() function definition is now from the dplyr package, and not from the stats package</span></span>
<span><span class="co"># the following two lines of code execute the same function</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co"># to access the stats definition of the filter function, use the namespace operator</span></span>
<span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<p>Most functions defined by a package can be accessed using the <code>::</code> operator, and
it is often a good idea to do so, to ensure you are calling the right function.</p>
</div>
</div>
<div id="importing-data" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Importing Data<a class="anchor" aria-label="anchor" href="#importing-data"><i class="fas fa-link"></i></a>
</h2>
<p>The first operation we typically must perform when analyzing data is reading our
data from a file into R. The <a href="https://readr.tidyverse.org/">readr</a> package in
the default tidyverse packages contains the <a href="https://readr.tidyverse.org/reference/read_delim.html">following similar
functions</a> that import
data from delimited text files:</p>
<div class="inline-table"><table style="width:92%;" class="table table-sm">
<colgroup>
<col width="20%">
<col width="70%">
</colgroup>
<thead><tr class="header">
<th>Function</th>
<th>Brief description/use</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>read_csv</code></td>
<td>Delimiter: <code>,</code> - Decimal separator: <code>.</code>
</td>
</tr>
<tr class="even">
<td><code>read_csv2</code></td>
<td>Delimiter: <code>;</code> - Decimal separator: <code>,</code>
</td>
</tr>
<tr class="odd">
<td><code>read_tsv</code></td>
<td>Delimiter: <code>&lt;tab&gt;</code> - Decimal separator: <code>.</code>
</td>
</tr>
<tr class="even">
<td><code>read_delim</code></td>
<td>Delimiter: set by user - Decimal separator: <code>.</code>
</td>
</tr>
</tbody>
</table></div>
<div class="box note">
<p>Some CSV files can be very large and may be
<a href="https://computer.howstuffworks.com/file-compression.htm">compressed</a> to save
space. There are many different file compression algorithms, but the most common
in data science and biology are <a href="https://www.gnu.org/software/gzip/">gzip</a> and
<a href="http://www.bzip.org/">bzip</a>. All the <code>readr</code> file reading functions can work
with compressed files directly, so you do not need to decompress them first.</p>
</div>
<p>Each of these functions returns a special data frame called a
<a href="data-wrangling.html#data-tibble"><code>tibble</code></a>, which is explained in the next section.</p>
<p>Note that <code>readr</code> also has functions for <a href="https://readr.tidyverse.org/reference/write_delim.html">writing delimited
files</a>. These functions
behave similarly to the <code>read_X</code> functions but instead of creating a tibble from
a file, they create a file from a tibble. You will frequently need to export the
results of your analysis to share with collaborators and also as part of larger
workflows that use tools other than R.</p>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/data-import.html">R for Data Science - Data Import</a></li>
<li><a href="https://readr.tidyverse.org/reference/read_delim.html">readr - <code>read_delim</code> reference</a></li>
<li><a href="https://readr.tidyverse.org/reference/write_delim.html">readr - <code>write_delim</code> reference</a></li>
</ul>
</div>
</div>
<div id="data-tibble" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> The tibble<a class="anchor" aria-label="anchor" href="#data-tibble"><i class="fas fa-link"></i></a>
</h2>
<p>Data in tidyverse is organized primarily in a special data frame object called a
<code>tibble</code>. The <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> function is defined in the <a href="https://tibble.tidyverse.org/">tibble
package</a> of the tidyverse:</p>
<pre><code>library(tibble) # or
library(tidyverse)
tbl &lt;- tibble(
    x = rnorm(100, mean=20, sd=10),
    y = rnorm(100, mean=50, sd=5)
)
tbl
# A tibble: 100 x 2
       x     y
   &lt;dbl&gt; &lt;dbl&gt;
 1 16.5   54.6
 2 14.4   54.3
 3  7.87  53.7
 4  8.06  50.8
 5 37.2   57.1
 6 16.5   51.9
 7 15.8   50.1
 8 40.3   44.3
 9 12.0   49.8
10 23.8   50.1
# ... with 90 more rows</code></pre>
<p>A <code>tibble</code> stores rectangular data, i.e. a grid of data elements with where
every column has the same number of rows. You can access individual columns in
the same way as with base R data frames:</p>
<pre><code>tbl$x
[1] 29.572549 12.015877 15.235536 23.071761 32.254703 48.048651 21.905756
[8] 15.511768 34.872685 21.352433 12.515230 23.608096  6.778630 12.342237
...
tbl[1,"x"] # access the first element of x
# A tibble: 1 x 1
    x
  &lt;dbl&gt;
1  29.6
tbl$x[1]
[1] 29.57255</code></pre>
<p><code>tibbles</code> (and regular data frames) typically have names for their columns. In
the above example, the column names are <code>x</code> and <code>y</code>, accessed using the
<code>colnames</code> function:</p>
<pre><code>colnames(tbl)
[1] "x" "y"</code></pre>
<p>Column names may be changed using this same function:</p>
<pre><code>colnames(tbl) &lt;- c("a","b")
tbl
# A tibble: 100 x 2
       a     b
   &lt;dbl&gt; &lt;dbl&gt;
 1 16.5   54.6
 2 14.4   54.3
 3  7.87  53.7
 4  8.06  50.8
 5 37.2   57.1
 6 16.5   51.9
 7 15.8   50.1
 8 40.3   44.3
 9 12.0   49.8
10 23.8   50.1
# ... with 90 more rows</code></pre>
<p>As we will see again later, we can also use <code><a href="https://dplyr.tidyverse.org/reference/rename.html">dplyr::rename</a></code> to rename columns as
well:</p>
<pre><code>dplyr::rename(tbl,
  a = x,
  b = y
)</code></pre>
<div class="box note">
<p>tibbles and dataframes also have row names as well as column names:</p>
<pre><code>rownames(tbl)
[1] "1" "2" "3"...</code></pre>
<p>However, the <code>tibble</code> support for row names is only included for compatibility
with base R data frames and should generally be avoided. The reason is that row
names are basically a character column that has different semantics than every
other column, and the authors of tidyverse believe row names are better stored
as a normal column.</p>
<p><a href="https://tibble.tidyverse.org/reference/rownames.html">tibble - working with row names</a></p>
</div>
<p>The tibble package provides a convenient way to construct simple tibbles
manually with the <code><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble()</a></code> function, which stands for “<code>tr</code>ansposed
t<code>ibble</code>”:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">gene</span>, <span class="op">~</span><span class="va">test1_stat</span>, <span class="op">~</span><span class="va">test1_p</span>, <span class="op">~</span><span class="va">test2_stat</span>, <span class="op">~</span><span class="va">test2_p</span>,</span>
<span>   <span class="st">"apoe"</span>, <span class="fl">12.509293</span>,   <span class="fl">0.1032</span>,   <span class="fl">34.239521</span>,   <span class="fl">1.3e-5</span>,</span>
<span>   <span class="st">"hoxd1"</span>,  <span class="fl">4.399211</span>,   <span class="fl">0.6323</span>,   <span class="fl">16.332318</span>,   <span class="fl">0.0421</span>,</span>
<span>   <span class="st">"snca"</span>, <span class="fl">45.748431</span>,   <span class="fl">4.2e-9</span>,    <span class="fl">0.757188</span>,   <span class="fl">0.9146</span>,</span>
<span><span class="op">)</span></span>
<span><span class="va">gene_stats</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   gene  test1_stat      test1_p test2_stat  test2_p
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 apoe       12.5  0.103            34.2   0.000013
## 2 hoxd1       4.40 0.632            16.3   0.0421  
## 3 snca       45.7  0.0000000042      0.757 0.915</code></pre>
<p>This made-up dataset includes statistics and p-values from two different
statistical tests (again, made up) for three human genes. We will use this
example below in the <a href="data-wrangling.html#arranging-data">Arranging Data</a> section.</p>
<div class="box readmore">
<ul>
<li><a href="https://tibble.tidyverse.org/">tibble documentation</a></li>
<li><a href="https://r4ds.had.co.nz/tibbles.html">R for Data Science - tibbles</a></li>
</ul>
</div>
</div>
<div id="tidy-data" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> Tidy Data<a class="anchor" aria-label="anchor" href="#tidy-data"><i class="fas fa-link"></i></a>
</h2>
<p>The tidyverse packages are designed to operate with so-called “tidy data”. From
the <a href="https://r4ds.had.co.nz/tidy-data.html">tidy data section</a> of the R for Data
Science book, the following rules make data tidy:</p>
<ol style="list-style-type: decimal">
<li>Each variable must have its own column.</li>
<li>Each observation must have its own row.</li>
<li>Each value must have its own cell.</li>
</ol>
<p>Here, a variable is a quantity or property that every observation in our dataset
has, and each observation is a separate instance of those variable (e.g. a
different sample, subject, etc). In our <code>gene_stats</code> example tibble above, the
columns referring to different test statistics are the variables, and each gene
in each row is an “observation”, and each cell has a value; we can therefore say
that the dataset is tidy:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   gene  test1_stat      test1_p test2_stat  test2_p
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 apoe       12.5  0.103            34.2   0.000013
## 2 hoxd1       4.40 0.632            16.3   0.0421  
## 3 snca       45.7  0.0000000042      0.757 0.915</code></pre>
<p>Each row being an “observation” is somewhat abstract in this case; we could say
that we “observed” the same test for all the genes in the tibble. Depending on
what dataset we are working with, we sometimes have to be flexible in our
conceptualization of what constitutes variables and observations.</p>
<p>The R for Data Science book depicts these rules in the following illustration:</p>
<div class="float">
<img src="https://d33wubrfki0l68.cloudfront.net/6f1ddb544fc5c69a2478e444ab8112fb0eea23f8/91adc/images/tidy-1.png" alt="Tidy data - from R for Data Science"><div class="figcaption">Tidy data - from R for Data Science</div>
</div>
<p>These rules are pretty generic, and in general a dataset might require some work
to manipulate it into tidy form. Fortunately for those of us working in biology
and bioinformatics, very many of our datasets are already provided in a format
that is very close to being tidy, or the tools we use to process biological data
do so for us. For this reason, details about the tidying operations that might
be needed for data in the general case are left for reading in the <a href="https://r4ds.had.co.nz/tidy-data.html">tidy data
section</a> of R for Data Science book.</p>
<div class="box important">
<p>There is one very big and common exception to the claim above that biological
data is usually already tidy that. Briefly, from the illustration above, tidy
data has observations as rows and variables as columns. However, the datasets
that we often use, e.g. gene expression matrices, are organized to have
variables (e.g. genes) as <em>rows</em> and observations (e.g. samples) as <em>columns</em>.
This means some operations to summarize variables across observations, which are
very common to compute, are not easily done with the tidyverse functions like
<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>. We describe how to work around this difference in the section
<a href="biology-bioinformatics.html#biological-data-is-not-tidy">Biological data is NOT Tidy!</a>.</p>
</div>
<div class="box readmore">
<p><a href="https://r4ds.had.co.nz/tidy-data.html">Tidy data - R for Data Science</a></p>
</div>
</div>
<div id="pipes" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> pipes<a class="anchor" aria-label="anchor" href="#pipes"><i class="fas fa-link"></i></a>
</h2>
<p>One of the key <code>tidyverse</code> programming patterns is chaining manipulations of
<code>tibble</code>s together using the <code>%&gt;%</code> operator. We very often want to perform
serial operations on a data frame, for example read in a file, rename one of the
columns, subset the rows based on some criteria, and compute summary statistics
on the result. We might implement such operations using a variable and
assignment:</p>
<pre><code># data_file.csv has two columns: bad_cOlumn_name and numeric_column
data &lt;- readr::read_csv("data_file.csv")
data &lt;- dplyr::rename(data, "better_column_name"=bad_cOlumn_name)
data &lt;- dplyr::filter(data, better_column_name %in% c("condA","condB"))
data_grouped &lt;- dplyr::group_by(data, better_column_name)
summarized &lt;- dplyr::summarize(data_grouped, mean(numeric_column))</code></pre>
<p>The repeated use of <code>data</code> and the intermediate <code>data_grouped</code> variable may
be unnecessary if you’re only interested in the summarized result. The code is
also not very straightforward to read. Using the <code>%&gt;%</code> operator, we can write
the same sequence of operations in a much more concise manner:</p>
<pre><code>data &lt;- readr::read_csv("data_file.csv") %&gt;%
      dplyr::rename("better_column_name"=bad_cOlumn_name) %&gt;%
      dplyr::filter(better_column_name %in% c("condA","condB")) %&gt;%
      dplyr::group_by(better_column_name) %&gt;%
      dplyr::summarize(mean(numeric_column))</code></pre>
<p>Note that the function calls in the piped example do not have the <code>data</code>
variable passed in explicitly. This is because the <code>%&gt;%</code> operator passes the
result of the function immediately preceding it as the first argument to the
next function automatically. This convention allows us to focus on writing only
the important parts of the code that perform the logic of our analysis, and
avoid unnecessary and potentially distracting additional characters that make
the code less readable.</p>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/pipes.html">R for Data Science - Pipes</a></li>
<li><a href="https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html"><code>%&gt;%</code> operator documentation in the magrittr package</a></li>
</ul>
</div>
</div>
<div id="arranging-data" class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> Arranging Data<a class="anchor" aria-label="anchor" href="#arranging-data"><i class="fas fa-link"></i></a>
</h2>
<p>After we have loaded our data from a file into a <code>tibble</code>, we often need to
manipulate it in various ways to make the values amenable to our desired
analysis. Such manipulations might include renaming poorly named columns,
filtering out certain records, deriving new columns using the values in others,
changing the order of rows etc. These operations may collectively be termed
<em>arranging</em> the data and many are provided in the
*<a href="https://dplyr.tidyverse.org/"><code>dplyr</code> package</a>. We will cover some of the most
common data arranging functions here, but there are many more in the <code>dplyr</code>
package worth knowing.</p>
<p>In the examples below, we will make use of the following made-up tibble that
contains fake statistics and p-values for three human genes:</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   gene  test1_stat      test1_p test2_stat  test2_p
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 apoe       12.5  0.103            34.2   0.000013
## 2 hoxd1       4.40 0.632            16.3   0.0421  
## 3 snca       45.7  0.0000000042      0.757 0.915</code></pre>
<p>The <code>gene_stats</code> tibble above is a simple example of a very common type of
data we work with in biology; namely instead of raw data, we work with
statistics that have been computed using raw data that help us interpret the
results. While these statistics may not be ‘data’ per se, we can still use all
the functions and strategies in the tidyverse to work with them.</p>
<div class="box note">
<p>The tidyverse is a very big place. RStudio created many helpful
<a href="https://github.com/rstudio/cheatsheets">cheatsheets</a> to aid in looking up how
do to certain operations. The <a href="https://github.com/rstudio/cheatsheets/blob/main/data-transformation.pdf">cheatsheet on
dplyr</a>
has lots of useful information on how to use the many functions in the package.</p>
</div>
<div id="dplyrmutate---create-new-columns-using-other-columns" class="section level3" number="5.7.1">
<h3>
<span class="header-section-number">5.7.1</span> <code>dplyr::mutate()</code> - Create new columns using other columns<a class="anchor" aria-label="anchor" href="#dplyrmutate---create-new-columns-using-other-columns"><i class="fas fa-link"></i></a>
</h3>
<p>Many biological analysis procedures perform some kind of statistical test on a
collection of features (e.g. genes) and produce p-values that indicate how
“surprising” each feature is according to the test. The p-values in our tibble
are nominal, i.e. they have not been adjusted for <a href="#ds-multiple-hypotheses">multiple
hypotheses</a>. Briefly, when we run multiple tests like
we are on each of our three genes, there is a chance that some of the tests will
have a small p-value simply by chance. <a href="https://en.wikipedia.org/wiki/Multiple_comparisons_problem">Multiple testing
correction</a>
procedures adjust nominal p-values to account for this possibility in a number
of different ways, but the most common procedure in biological analysis is the
<a href="https://en.wikipedia.org/wiki/False_discovery_rate">Benjamini-Hochberg or False Discovery Rate
(FDR)</a> procedure. In R, the
<code>p.adjust</code> function can perform several of these procedures, including FDR:</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">gene_stats</span>,</span>
<span>  test1_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test1_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 6
##   gene  test1_stat      test1_p test2_stat  test2_p   test1_padj
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;
## 1 apoe       12.5  0.103            34.2   0.000013 0.155       
## 2 hoxd1       4.40 0.632            16.3   0.0421   0.632       
## 3 snca       45.7  0.0000000042      0.757 0.915    0.0000000126</code></pre>
<p>Notice how the adjusted p-values are larger than the nominal ones; this is the
effect of the multiple testing procedure. Since we have two sets of p-values,
we must compute the FDR on each of them, which we can do in the same call to
<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>:</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats_mutated</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">gene_stats</span>,</span>
<span>  test1_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test1_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  test2_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test2_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gene_stats_mutated</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 7
##   gene  test1_stat      test1_p test2_stat  test2_p   test1_padj test2_padj
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;
## 1 apoe       12.5  0.103            34.2   0.000013 0.155          0.000039
## 2 hoxd1       4.40 0.632            16.3   0.0421   0.632          0.0632  
## 3 snca       45.7  0.0000000042      0.757 0.915    0.0000000126   0.915</code></pre>
<p>Another common operation is to create new columns derived from the values in
multiple other columns. We (or our wetlab colleagues) might decide it is
convenient to have a new column with <code>TRUE</code> or <code>FALSE</code> based on whether the
gene was significant in either test. Such a column would make it easy to filter
genes down to just ones that might be interesting in tools like Excel. We can
create new columns from multiple columns just as easily using the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>
function:</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">gene_stats_mutated</span>,</span>
<span>  signif_either<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">|</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  signif_both<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">&amp;</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 9
##   gene  test1_stat      test1_p test2_stat  test2_p   test1_padj test2_padj
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;
## 1 apoe       12.5  0.103            34.2   0.000013 0.155          0.000039
## 2 hoxd1       4.40 0.632            16.3   0.0421   0.632          0.0632  
## 3 snca       45.7  0.0000000042      0.757 0.915    0.0000000126   0.915   
## # ... with 2 more variables: signif_either &lt;lgl&gt;, signif_both &lt;lgl&gt;</code></pre>
<p>Recall that the <code>|</code> and <code>&amp;</code> operators execute ‘or’ and ‘and’ logic,
respectively. The above example required the creation of a new variable
<code>gene_stats_mutated</code> because the columns <code>test1_padj</code> and
<code>test2_padj</code> need to be in the tibble before computing the new fields. However,
in <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>, columns created first in the function call are available to later
columns. In the following example, note that <code>test1_padj</code> is created first and
then used to create the <code>signif</code> columns:</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">gene_stats</span>,</span>
<span>  test1_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test1_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>, <span class="co"># test1_padj created</span></span>
<span>  test2_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test2_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  signif_either<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">|</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>, <span class="co">#test1_padj used</span></span>
<span>  signif_both<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">&amp;</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 9
##   gene  test1_stat      test1_p test2_stat  test2_p   test1_padj test2_padj
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;
## 1 apoe       12.5  0.103            34.2   0.000013 0.155          0.000039
## 2 hoxd1       4.40 0.632            16.3   0.0421   0.632          0.0632  
## 3 snca       45.7  0.0000000042      0.757 0.915    0.0000000126   0.915   
## # ... with 2 more variables: signif_either &lt;lgl&gt;, signif_both &lt;lgl&gt;</code></pre>
<p>The alternative would be to split this into two <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> commands, the first
creating the adjusted p-value columns and the second creating the significance
columns. <code>dplyr</code> recognizes how common it is to build new variables off of other
new variables in a <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> command, and therefore provides this convenient
behavior.</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> can also be used to modify columns in place. The official convention
for human gene symbols is that they are upper case, but for some reason our
tibble contains lower case gene symbols. We can correct this using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>
but first we should talk about the <a href="https://stringr.tidyverse.org/">stringr
package</a> which makes working with strings much
easier than with base R functions.</p>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/transform.html#add-new-variables-with-mutate">R for Data Science - Add new variables with <code>mutate()</code></a></li>
<li><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr <code>mutate()</code> reference</a></li>
</ul>
</div>
</div>
<div id="stringr---working-with-character-values" class="section level3" number="5.7.2">
<h3>
<span class="header-section-number">5.7.2</span> <code>stringr</code> - Working with character values<a class="anchor" aria-label="anchor" href="#stringr---working-with-character-values"><i class="fas fa-link"></i></a>
</h3>
<p>Base R does not have very convenient functions for working with character
strings (or just <em>strings</em>). This is due to its original intent a statistical
programming language, where string manipulation is not (in principle) a common
operation. However, in practice, we must frequently manipulate strings while
loading, cleaning, and analyzing datasets. The <a href="https://stringr.tidyverse.org/">stringr
package</a> aims to make working with strings “as
easy as possible.”</p>
<p>The package includes many useful functions for operating on strings, including
searching for patterns, mutating strings, lexicographical sorting, combining
multiple strings together (i.e. concatenation), and performing complex
search/replace operations. There are far too many useful functions to cover here
and you should become comfortable reading the <a href="https://stringr.tidyverse.org/reference/index.html">stringr
documentation</a> and the very
helpful <a href="https://github.com/rstudio/cheatsheets/blob/main/strings.pdf">stringr
cheatsheet</a>.</p>
<p>In the previous section, we noted that the gene symbols in our tibble were lower
case while official gene symbols are in upper case. We can use the stringr
function <code><a href="https://stringr.tidyverse.org/reference/case.html">stringr::str_to_upper()</a></code> with the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> function to
perform this adjustment easily:</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">gene_stats</span>,</span>
<span>  gene<span class="op">=</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   gene  test1_stat      test1_p test2_stat  test2_p
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 APOE       12.5  0.103            34.2   0.000013
## 2 HOXD1       4.40 0.632            16.3   0.0421  
## 3 SNCA       45.7  0.0000000042      0.757 0.915</code></pre>
<p>Now are gene symbols have the appropriate case, and our wetlab colleagues won’t
complain about it. :)</p>
<div id="regular-expressions" class="section level4" number="5.7.2.1">
<h4>
<span class="header-section-number">5.7.2.1</span> Regular expressions<a class="anchor" aria-label="anchor" href="#regular-expressions"><i class="fas fa-link"></i></a>
</h4>
<p>Many of the string operations in the <code>stringr</code> package use <a href="https://en.wikipedia.org/wiki/Regular_expression">regular
expression</a> syntax. A regular
expression is a sequence of characters that describes patterns in text. Regular
expressions are written in a sort of mini programming language where certain
characters have special meaning that help in defining <em>search patterns</em> that
identifies the location of sequences of characters in text that follow a
particular pattern specified by the regular expression. This is similar to the
“Find” functionality in many word processors, but is more powerful due to the
flexibility of the patterns that can be found.</p>
<p>A simple example will be helpful. Let’s say we have a tibble containing the
result of a (made-up) statistical test for all the genes in a genome:</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">de_genes</span></span></code></pre></div>
<pre><code>## # A tibble: 39,535 x 4
##    hgnc_symbol  mean        p    padj
##    &lt;chr&gt;       &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;
##  1 MT-TF        5799 0.000910 0.00941
##  2 MT-RNR1       153 0.0272   0.0342 
##  3 MT-TV         115 0.0228   0.0301 
##  4 MT-RNR2       495 0.00318  0.0123 
##  5 MT-TL1      20201 0.000377 0.00841
##  6 MT-ND1        160 0.0179   0.0258 
##  7 MT-TI        3511 0.00247  0.0115 
##  8 MT-TQ         772 0.00376  0.0129 
##  9 MT-TM         301 0.00325  0.0124 
## 10 MT-ND2         12 0.107    0.111  
## # ... with 39,525 more rows</code></pre>
<p>Now let’s say we’re interested in examining the results for the BRCA family of
genes, BRCA1 and BRCA2. We can use <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> on the data frame to look for them
individually:</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">de_genes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hgnc_symbol</span> <span class="op">==</span> <span class="st">"BRCA1"</span> <span class="op">|</span> <span class="va">hgnc_symbol</span> <span class="op">==</span> <span class="st">"BRCA2"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##   hgnc_symbol  mean      p   padj
##   &lt;chr&gt;       &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 BRCA1          41 0.0321 0.0386
## 2 BRCA2         447 0.0140 0.0223</code></pre>
<p>This isn’t so bad, but we can do the same thing with
<a href="https://stringr.tidyverse.org/reference/str_detect.html"><code>stringr::str_detect()</code></a>
, which returns <code>TRUE</code> if the provided pattern matches the input and <code>FALSE</code>
otherwise, a regular expression, and the [<code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> function], which is
described in greater detail in a later section:</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">de_genes</span>, <span class="fu">str_detect</span><span class="op">(</span><span class="va">hgnc_symbol</span>,<span class="st">"^BRCA[12]$"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##   hgnc_symbol  mean      p   padj
##   &lt;chr&gt;       &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 BRCA1          41 0.0321 0.0386
## 2 BRCA2         447 0.0140 0.0223</code></pre>
<p>The argument <code>"^BRCA[12]$"</code> is a regular expression that searches for the
following:</p>
<ul>
<li>Search for genes that start with the characters <code>BRCA</code> - the <code>^</code> at the
beginning of the pattern stands for the start of the string</li>
<li>For genes that start with <code>BRCA</code>, then look for genes where the next character
is either <code>1</code> or <code>2</code> with <code>[12]</code> - the characters between the <code>[]</code> are searched
for explicitly, and any character encountered that is not listed between them
results in a non-match</li>
<li>For genes that start with <code>BRCA</code> followed with either a <code>1</code> or a <code>2</code>, match
successfully if the number is at the end of the name - the <code>$</code> at the end of the
pattern stands for the end of the string</li>
</ul>
<p>We can use these principles to find genes with more complex naming conventions.
The <a href="https://www.nature.com/articles/pr19972506">Homeobox (HOX) genes</a> encode
DNA binding proteins that regulate gene expression of genes involved in
morphgenesis and cell differentiation in vertebrates. In humans, HOX genes are
organized into 4 clusters of paralogs that were the result of three DNA
duplication events in the distant evolutionary past<span class="citation">(<a href="detailed-class-schedule.html#ref-Abbasi2015-rn">Abbasi 2015</a>)</span>, where each
cluster encodes a subset of 13 distinct HOX genes placed next to each other.
Each of these clusters has been assigned a letter identifier A-D (e.g. HOXA,
HOXB, HOXC, and HOXD) and each paralogous gene within each cluster is assigned
the same number (e.g. HOXA4, HOXB4, HOXC4, and HOXD4 are paralogs). There are 13
HOX genes in total, though not all genes remain in all clusters (e.g. HOXA1,
HOXB1, and HOXD1 exist but HOXC1 was lost over time). The following figure
depicts the human HOX gene clusters:</p>
<div class="float">
<img src="human_hox.jpg" alt="Human HOX gene clusters - Veraksa, A.; Del Campo, M.; McGinnis, W. Developmental Patterning Genes and their Conserved Functions: From Model Organisms to Humans. Mol. Genet. Metab. 2000, 69 (2), 85–100."><div class="figcaption">Human HOX gene clusters - Veraksa, A.; Del Campo, M.; McGinnis, W. Developmental Patterning Genes and their Conserved Functions: From Model Organisms to Humans. Mol. Genet. Metab. 2000, 69 (2), 85–100.</div>
</div>
<p>Let’s say we want to extract out all the HOX genes from our gene statistics. We
can write a regular expression that matches the pattern described above:</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">de_genes</span>, <span class="fu">str_detect</span><span class="op">(</span><span class="va">hgnc_symbol</span>,<span class="st">"^HOX[A-D][0-9]+$"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">hgnc_symbol</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 39 x 4
##    hgnc_symbol  mean        p    padj
##    &lt;chr&gt;       &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;
##  1 HOXA1        8734 0.000858 0.00934
##  2 HOXA10       4149 0.00152  0.0102 
##  3 HOXA11        567 0.0101   0.0188 
##  4 HOXA13        411 0.0105   0.0191 
##  5 HOXA2         554 0.00600  0.0151 
##  6 HOXA3          18 0.0919   0.0959 
##  7 HOXA4         475 0.0113   0.0199 
##  8 HOXA5         434 0.0127   0.0211 
##  9 HOXA6        3983 0.00252  0.0115 
## 10 HOXA7         897 0.00961  0.0183 
## # ... with 29 more rows</code></pre>
<p>In this query we used two new regular expression features:</p>
<ul>
<li>within the <code>[]</code> we specified a range of characters <code>A-D</code> and <code>0-9</code> which will
match any of the characters between A and D (i.e. A, B, C, or D) and 0 and 9
respectively</li>
<li>the <code>+</code> character means “match one or more of the preceding expression”, which
in our case is the <code>[0-9]</code>. This allows us to match genes with only a single
number (e.g. <code>HOXA1</code>) as well as double digit numbers (e.g. <code>HOXA10</code>).</li>
</ul>
<p>Since we know the cluster identifier part of the HOX gene names (i.e. the
<code>[A-D]</code> part) is exactly one character long, we could alternatively write the
regular expression as follows, using the special <code>.</code> character:</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">de_genes</span>, <span class="fu">str_detect</span><span class="op">(</span><span class="va">hgnc_symbol</span>,<span class="st">"^HOX.[0-9]+$"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">hgnc_symbol</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 39 x 4
##    hgnc_symbol  mean        p    padj
##    &lt;chr&gt;       &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;
##  1 HOXA1        8734 0.000858 0.00934
##  2 HOXA10       4149 0.00152  0.0102 
##  3 HOXA11        567 0.0101   0.0188 
##  4 HOXA13        411 0.0105   0.0191 
##  5 HOXA2         554 0.00600  0.0151 
##  6 HOXA3          18 0.0919   0.0959 
##  7 HOXA4         475 0.0113   0.0199 
##  8 HOXA5         434 0.0127   0.0211 
##  9 HOXA6        3983 0.00252  0.0115 
## 10 HOXA7         897 0.00961  0.0183 
## # ... with 29 more rows</code></pre>
<p>Here, the <code>.</code> character is interpreted by the regex to match <em>any single
character</em>, regardless of what it is, between the <code>HOX</code> part and the number
part. This also requires that there exist exactly one character between the two
parts; a gene symbol <code>HOX1</code> would <em>not</em> be matched, because the <code>1</code> would match
to the <code>.</code>, but no number remains to match to the <code>[0-9]+</code> part.</p>
<div class="box note">
<p>Sometimes you want to search text for characters that are considered special in
the regular expression language. For example, if you had a list of filenames:</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filenames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">name</span>,</span>
<span>  <span class="st">"annotation.csv"</span>,</span>
<span>  <span class="st">"file1.txt"</span>,</span>
<span>  <span class="st">"file2.txt"</span>,</span>
<span>  <span class="st">"results.csv"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>and wanted to limit to just those with the <code>.txt</code> extension, you need to match
using a literal <code>.</code> character:</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">filenames</span>, <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">name</span>,<span class="st">"[.]txt$"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 1
##   name     
##   &lt;chr&gt;    
## 1 file1.txt
## 2 file2.txt</code></pre>
<p>Inside a <code>[]</code>, characters do not have their usual regular expression meaning,
and therefore <code>[.]</code> will match a literal <code>.</code> character. Instead of using the
<code>[]</code> syntax, you may also escape these literal characters using two back
slashes:</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">filenames</span>, <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">name</span>,<span class="st">"\\.txt$"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 1
##   name     
##   &lt;chr&gt;    
## 1 file1.txt
## 2 file2.txt</code></pre>
</div>
<p>Regular expressions are very powerful, and can do much more than what is
described here. See the regular expression tutorial linked in the readmore box
to learn more details.</p>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/strings.html">R for Data Science - Strings</a></li>
<li><a href="https://stringr.tidyverse.org/reference/index.html">stringr
documentation</a></li>
<li><a href="https://github.com/rstudio/cheatsheets/blob/main/strings.pdf">stringr
cheatsheet</a></li>
<li><a href="https://regexone.com/">RegexOne - regular expression tutorial</a></li>
</ul>
</div>
</div>
</div>
<div id="dplyrselect---subset-columns-by-name" class="section level3" number="5.7.3">
<h3>
<span class="header-section-number">5.7.3</span> <code>dplyr::select()</code> - Subset Columns by Name<a class="anchor" aria-label="anchor" href="#dplyrselect---subset-columns-by-name"><i class="fas fa-link"></i></a>
</h3>
<p>Our <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> operations above created a number of new columns in our tibble,
but we did not specify where in the tibble the new columns should go. Let’s
consider the mutated tibble we created with all four new columns:</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">gene_stats</span>,</span>
<span>  test1_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test1_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  test2_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test2_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  signif_either<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">|</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  signif_both<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">&amp;</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  gene<span class="op">=</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 9
##   gene  test1_stat      test1_p test2_stat  test2_p   test1_padj test2_padj
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;
## 1 APOE       12.5  0.103            34.2   0.000013 0.155          0.000039
## 2 HOXD1       4.40 0.632            16.3   0.0421   0.632          0.0632  
## 3 SNCA       45.7  0.0000000042      0.757 0.915    0.0000000126   0.915   
## # ... with 2 more variables: signif_either &lt;lgl&gt;, signif_both &lt;lgl&gt;</code></pre>
<p>From a readability standpoint, it might be helpful if all the columns that are
about each test were grouped together, rather than having to look at the end of
the tibble to find them.</p>
<p>The <a href="https://dplyr.tidyverse.org/reference/select.html"><code>dplyr::select()</code>
function</a> allows you to pick
specific columns out of a larger <code>tibble</code> in whatever order you choose:</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gene_stats</span>, <span class="va">test1_stat</span>, <span class="va">test2_stat</span><span class="op">)</span></span>
<span><span class="va">stats</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   test1_stat test2_stat
##        &lt;dbl&gt;      &lt;dbl&gt;
## 1      12.5      34.2  
## 2       4.40     16.3  
## 3      45.7       0.757</code></pre>
<p>Here we have explicitly selected the statistics columns. dplyr also has <a href="https://tidyselect.r-lib.org/reference/starts_with.html">helper
functions</a> that allow
for more flexible selection of columns. For example, if all of the columns we
wished to select ended with <code>_stat</code>, we could use the <code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with()</a></code> helper
function:</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gene_stats</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"_stat"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">stats</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   test1_stat test2_stat
##        &lt;dbl&gt;      &lt;dbl&gt;
## 1      12.5      34.2  
## 2       4.40     16.3  
## 3      45.7       0.757</code></pre>
<p>If you so desire, <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> allows for the renaming of selected columns:</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gene_stats</span>,</span>
<span>  t<span class="op">=</span><span class="va">test1_stat</span>,</span>
<span>  chisq<span class="op">=</span><span class="va">test2_stat</span></span>
<span><span class="op">)</span></span>
<span><span class="va">stats</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##       t  chisq
##   &lt;dbl&gt;  &lt;dbl&gt;
## 1 12.5  34.2  
## 2  4.40 16.3  
## 3 45.7   0.757</code></pre>
<p>If we knew that these test statistics actually corresponded to some kind of
t-test and a <span class="math inline">\(\chi\)</span>-squared test, naming the columns of the tibble appropriately
may help others (and possibly you) understand your code better.</p>
<p>We can use the <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select()</a></code> function to obtain our desired column order:</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">gene_stats</span>,</span>
<span>  test1_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test1_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  test2_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test2_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  signif_either<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">|</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  signif_both<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">&amp;</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  gene<span class="op">=</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="va">gene</span>,</span>
<span>    <span class="va">test1_stat</span>, <span class="va">test1_p</span>, <span class="va">test1_padj</span>,</span>
<span>    <span class="va">test2_stat</span>, <span class="va">test2_p</span>, <span class="va">test2_padj</span>,</span>
<span>    <span class="va">signif_either</span>,</span>
<span>    <span class="va">signif_both</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 9
##   gene  test1_stat      test1_p   test1_padj test2_stat  test2_p test2_padj
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
## 1 APOE       12.5  0.103        0.155            34.2   0.000013   0.000039
## 2 HOXD1       4.40 0.632        0.632            16.3   0.0421     0.0632  
## 3 SNCA       45.7  0.0000000042 0.0000000126      0.757 0.915      0.915   
## # ... with 2 more variables: signif_either &lt;lgl&gt;, signif_both &lt;lgl&gt;</code></pre>
<p>Now the order of our columns is clear and convenient. It is not necessary to
list the columns for each test statistic on the same line, but the author thinks
this makes the code easier to read and understand.</p>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/transform.html#select">R for Data Science - Select columns with <code>select()</code></a></li>
<li><a href="https://dplyr.tidyverse.org/reference/index.html">dplyr reference</a></li>
<li><a href="https://tidyselect.r-lib.org/reference/starts_with.html">select helper functions</a></li>
</ul>
</div>
</div>
<div id="dplyrfilter---pick-rows-out-of-a-data-set" class="section level3" number="5.7.4">
<h3>
<span class="header-section-number">5.7.4</span> <code>dplyr::filter()</code> - Pick rows out of a data set<a class="anchor" aria-label="anchor" href="#dplyrfilter---pick-rows-out-of-a-data-set"><i class="fas fa-link"></i></a>
</h3>
<p>Often, the first step in interpreting an analysis is to identify the features
that are significant at some adjusted p-value threshold. First we will
save our mutated tibble to another variable, to aid in demonstration:</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats_mutated</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">gene_stats</span>,</span>
<span>  test1_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test1_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  test2_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test2_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  signif_either<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">|</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  signif_both<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">&amp;</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  gene<span class="op">=</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="va">gene</span>,</span>
<span>    <span class="va">test1_stat</span>, <span class="va">test1_p</span>, <span class="va">test1_padj</span>,</span>
<span>    <span class="va">test2_stat</span>, <span class="va">test2_p</span>, <span class="va">test2_padj</span>,</span>
<span>    <span class="va">signif_either</span>,</span>
<span>    <span class="va">signif_both</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we can use the <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> function to select rows based on whether
they are significant in either test this with our above example.</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">gene_stats_mutated</span>, <span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 1 x 9
##   gene  test1_stat      test1_p   test1_padj test2_stat test2_p test2_padj
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;
## 1 SNCA        45.7 0.0000000042 0.0000000126      0.757   0.915      0.915
## # ... with 2 more variables: signif_either &lt;lgl&gt;, signif_both &lt;lgl&gt;</code></pre>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">gene_stats_mutated</span>, <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 1 x 9
##   gene  test1_stat test1_p test1_padj test2_stat  test2_p test2_padj
##   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
## 1 APOE        12.5   0.103      0.155       34.2 0.000013   0.000039
## # ... with 2 more variables: signif_either &lt;lgl&gt;, signif_both &lt;lgl&gt;</code></pre>
<p>Here we are filtering the result so that only genes with nominal p-value less
than 0.05 remain. Note we filter on the two tests separately, but we can also
combine these tests using <a href="https://r4ds.had.co.nz/transform.html#logical-operators">logical
operators</a> to achieve
different results:</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># | means "logical or", meaning the row is retained if either condition is true</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">gene_stats_mutated</span>, <span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">|</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 9
##   gene  test1_stat      test1_p   test1_padj test2_stat  test2_p test2_padj
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
## 1 APOE        12.5 0.103        0.155            34.2   0.000013   0.000039
## 2 SNCA        45.7 0.0000000042 0.0000000126      0.757 0.915      0.915   
## # ... with 2 more variables: signif_either &lt;lgl&gt;, signif_both &lt;lgl&gt;</code></pre>
<p>Only APOE and SCNA are significant in at least one of the tests.</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># &amp; means "logical and", meaning the row is retained only if both conditions are true</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">gene_stats_mutated</span>, <span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">&amp;</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 0 x 9
## # ... with 9 variables: gene &lt;chr&gt;, test1_stat &lt;dbl&gt;, test1_p &lt;dbl&gt;,
## #   test1_padj &lt;dbl&gt;, test2_stat &lt;dbl&gt;, test2_p &lt;dbl&gt;, test2_padj &lt;dbl&gt;,
## #   signif_either &lt;lgl&gt;, signif_both &lt;lgl&gt;</code></pre>
<p>It looks like we don’t have any genes that are significant by both tests.
Filtering results like this is one of the most common operations we do on the
results of biological analyses.</p>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/transform.html#filter-rows-with-filter">R for Data Science - Filter rows with <code>filter()</code></a></li>
<li><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr - <code>filter()</code> reference</a></li>
</ul>
</div>
</div>
<div id="dplyrarrange---order-rows-based-on-their-values" class="section level3" number="5.7.5">
<h3>
<span class="header-section-number">5.7.5</span> <code>dplyr::arrange()</code> - Order rows based on their values<a class="anchor" aria-label="anchor" href="#dplyrarrange---order-rows-based-on-their-values"><i class="fas fa-link"></i></a>
</h3>
<p>Another common operation when working with biological analysis results is
ordering them by some meaningful value. Like above, p-values are often used to
prioritize results by simply sorting them in ascending order. The <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>
function is how to perform this sorting in tidyverse:</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats_sorted_by_test1_p</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">gene_stats</span>, <span class="va">test1_p</span><span class="op">)</span></span>
<span><span class="va">stats_sorted_by_test1_p</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   gene  test1_stat      test1_p test2_stat  test2_p
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 snca       45.7  0.0000000042      0.757 0.915   
## 2 apoe       12.5  0.103            34.2   0.000013
## 3 hoxd1       4.40 0.632            16.3   0.0421</code></pre>
<div class="box note">
<p>Note we are sorting by nominal p-value here, not adjusted p-value. In general,
sorting by nominal or adjusted p-value results in the same order of results. The
only exception is when, due to the way the FDR procedure works, some adjusted
p-values will be identical, making the relative order of those tests with the
same FDR meaningless. In contrast, it is very rare that nominal p-values will be
identical, and since they induce the same ordering of results, when sorting
analysis results there are advantages to using nominal p-value, rather than
adjusted p-value.</p>
</div>
<p>In general, the larger the magnitude of the statistic, the smaller the p-value
(for two-tailed tests), so if we so desired we could induce a similar ranking by
arranging the data by the statistic in descending order:</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># desc() is a helper function that causes the results to be sorted in descending</span></span>
<span><span class="co"># order for the given column</span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">gene_stats</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">test1_stat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   gene  test1_stat      test1_p test2_stat  test2_p
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 snca       45.7  0.0000000042      0.757 0.915   
## 2 apoe       12.5  0.103            34.2   0.000013
## 3 hoxd1       4.40 0.632            16.3   0.0421</code></pre>
<p>Here we first apply the base R <code><a href="https://rdrr.io/r/base/MathFun.html">abs()</a></code> function to compute the absolute value of
the test 1 statistic and then specify that we want to sort largest first. Note
although we don’t have any negative values in our dataset, we should not assume
that in general, so it is safer for us to be complete and add the absolute value
call in case later we decide to copy and paste this code into another analysis.
That’s pretty much all there is to <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>.</p>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/transform.html#arrange-rows-with-arrange">R for Data Science - Arrange rows with<code>arrange()</code></a></li>
<li><a href="https://dplyr.tidyverse.org/reference/arrange.html">dplyr <code>arrange()</code> reference</a></li>
</ul>
</div>
</div>
<div id="putting-it-all-together" class="section level3" number="5.7.6">
<h3>
<span class="header-section-number">5.7.6</span> Putting it all together<a class="anchor" aria-label="anchor" href="#putting-it-all-together"><i class="fas fa-link"></i></a>
</h3>
<p>In the previous sections, we performed the following operations:</p>
<ol style="list-style-type: decimal">
<li>Created new columns by computing false discovery rate on the nominal p-values
using the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> and <code>p.adjust</code> functions</li>
<li>Created new columns that indicate the patterns of significance for each gene
using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code>
</li>
<li>Mutated the gene symbol case using <code><a href="https://stringr.tidyverse.org/reference/case.html">stringr::str_to_upper</a></code> and
<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code>
</li>
<li>Reordered the columns to group related variables with <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>
</li>
<li>Filtered genes based on whether they have an adjusted p-value less than 0.05
for either and both statistical tests using <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code>
</li>
<li>Sorted the results by p-value using <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">dplyr::arrange()</a></code>
</li>
</ol>
<p>For the sake of illustration, these steps were presented separately, but
together they represent a single unit of data processing and thus might
profitably be done in the same R command using <code>%&gt;%</code>:</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">gene_stats</span>,</span>
<span>  test1_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test1_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  test2_padj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">test2_p</span>,method<span class="op">=</span><span class="st">"fdr"</span><span class="op">)</span>,</span>
<span>  signif_either<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">|</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  signif_both<span class="op">=</span><span class="op">(</span><span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">&amp;</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>  gene<span class="op">=</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="va">gene</span>,</span>
<span>    <span class="va">test1_stat</span>, <span class="va">test1_p</span>, <span class="va">test1_padj</span>,</span>
<span>    <span class="va">test2_stat</span>, <span class="va">test2_p</span>, <span class="va">test2_padj</span>,</span>
<span>    <span class="va">signif_either</span>,</span>
<span>    <span class="va">signif_both</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">test1_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">|</span> <span class="va">test2_padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span></span>
<span>  <span class="va">test1_p</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gene_stats</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 9
##   gene  test1_stat      test1_p   test1_padj test2_stat  test2_p test2_padj
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
## 1 SNCA        45.7 0.0000000042 0.0000000126      0.757 0.915      0.915   
## 2 APOE        12.5 0.103        0.155            34.2   0.000013   0.000039
## # ... with 2 more variables: signif_either &lt;lgl&gt;, signif_both &lt;lgl&gt;</code></pre>
<p>This complete pipeline now contains all of our manipulations and our mutated
tibble can be passed on to downstream analysis or collaborators.</p>
</div>
</div>
<div id="grouping-data" class="section level2" number="5.8">
<h2>
<span class="header-section-number">5.8</span> Grouping Data<a class="anchor" aria-label="anchor" href="#grouping-data"><i class="fas fa-link"></i></a>
</h2>
<p>Sometimes we are interested in summarizing subsets of our data defined by some
grouping variable. Consider the following made-up sample metadata for a set of
individuals in an Alzheimer’s disease (AD) study:</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">ID</span>, <span class="op">~</span><span class="va">condition</span>, <span class="op">~</span><span class="va">age_at_death</span>, <span class="op">~</span><span class="va">Braak_stage</span>, <span class="op">~</span><span class="va">APOE_genotype</span>,</span>
<span>  <span class="st">"A01"</span>,        <span class="st">"AD"</span>,            <span class="fl">78</span>,            <span class="fl">5</span>,       <span class="st">"e4/e4"</span>,</span>
<span>  <span class="st">"A02"</span>,        <span class="st">"AD"</span>,            <span class="fl">81</span>,            <span class="fl">6</span>,       <span class="st">"e3/e4"</span>,</span>
<span>  <span class="st">"A03"</span>,        <span class="st">"AD"</span>,            <span class="fl">90</span>,            <span class="fl">5</span>,       <span class="st">"e4/e4"</span>,</span>
<span>  <span class="st">"A04"</span>,   <span class="st">"Control"</span>,            <span class="fl">80</span>,            <span class="fl">1</span>,       <span class="st">"e3/e4"</span>,</span>
<span>  <span class="st">"A05"</span>,   <span class="st">"Control"</span>,            <span class="fl">79</span>,            <span class="fl">0</span>,       <span class="st">"e3/e3"</span>,</span>
<span>  <span class="st">"A06"</span>,   <span class="st">"Control"</span>,            <span class="fl">81</span>,            <span class="fl">0</span>,       <span class="st">"e2/e3"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This is a typical setup for metadata in these types of experiments. There is a
sample ID column which uniquely identifies each subject, a condition variable
indicating which group each subject is in, and clinical information like age at
death, Braak stage (a measure of Alzheimer’s disease pathology in the brain),
and diploid APOE genotype (e2 is associated with reduced risk of AD, e3 is
baseline, and e4 confers increased risk).</p>
<p>An important experimental design consideration is to match sample attributes
between groups as well as possible to avoid confounding our comparison of
interest. In this case, age at death is one such variable that we wish to match
between groups. Although these values look pretty well matched between AD and
Control groups, it would be better to check explicitly. We can do this using
<code><a href="https://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by()</a></code> to group the rows together based on condition and
<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code> to compute the mean age at death for each group:</p>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">metadata</span>,</span>
<span>  <span class="va">condition</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_age_at_death <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">age_at_death</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   condition mean_age_at_death
##   &lt;chr&gt;                 &lt;dbl&gt;
## 1 AD                       83
## 2 Control                  80</code></pre>
<p>The <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by()</a></code> accepts a tibble and a column name for
a column that contains a categorical variable (i.e. a variable with discrete
values like AD and Control) and separates the rows in the tibble into groups
according to the distinct values of the column. The <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code>
function accepts the grouped tibble and creates a new tibble with contents
defined as a function of values for columns in for each group.</p>
<p>From the example above, we see that the mean age at death is indeed different
between the two groups, but not by much. We can go one step further and compute
the standard deviation age range to further investigate:</p>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">metadata</span>,</span>
<span>  <span class="va">condition</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>  mean_age_at_death <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">age_at_death</span><span class="op">)</span>,</span>
<span>  sd_age_at_death <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">age_at_death</span><span class="op">)</span>,</span>
<span>  lower_age <span class="op">=</span> <span class="va">mean_age_at_death</span><span class="op">-</span><span class="va">sd_age_at_death</span>,</span>
<span>  upper_age <span class="op">=</span> <span class="va">mean_age_at_death</span><span class="op">+</span><span class="va">sd_age_at_death</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 5
##   condition mean_age_at_death sd_age_at_death lower_age upper_age
##   &lt;chr&gt;                 &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 AD                       83            6.24      76.8      89.2
## 2 Control                  80            1         79        81</code></pre>
<p>Note the use of summarized variables defined first being used in variables
defined later. Now we can see that the age ranges defined by +/- one standard
deviation clearly overlap, which gives us more confidence that our average age
at death for AD and Control are not significantly different.</p>
<div class="box note">
<p>We used +/- one standard deviation to define the likely mean age range above and
below the arithmetic mean for simplicity in the example above. The proper way to
assess whether these distributions are significantly different is to use an
appropriate statistical test like a t-test.</p>
</div>
<p>Like other functions in <code>dplyr</code>, <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code> has some helper functions
that give it additional functionality. One useful helper function is <code><a href="https://dplyr.tidyverse.org/reference/context.html">n()</a></code>,
which is defined as the number of records within each group. We will add one
more column to our summarized sample metadata from above that reports the number
of subjects within each condition:</p>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">metadata</span>,</span>
<span>  <span class="va">condition</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>  num_subjects <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  mean_age_at_death <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">age_at_death</span><span class="op">)</span>,</span>
<span>  sd_age_at_death <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">age_at_death</span><span class="op">)</span>,</span>
<span>  lower_age <span class="op">=</span> <span class="va">mean_age_at_death</span><span class="op">-</span><span class="va">sd_age_at_death</span>,</span>
<span>  upper_age <span class="op">=</span> <span class="va">mean_age_at_death</span><span class="op">+</span><span class="va">sd_age_at_death</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   condition num_subjects mean_age_at_death sd_age_at_death lower_age upper_age
##   &lt;chr&gt;            &lt;int&gt;             &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 AD                   3                83            6.24      76.8      89.2
## 2 Control              3                80            1         79        81</code></pre>
<p>We now have a column with the number of subjects in each condition.</p>
<div class="box note">
<p>Hadley Wickham is from New Zealand, which uses British, rather than American,
English. Therefore, in many places, both spellings are supported in the
tidyverse; e.g. both <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> are supported.</p>
</div>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/transform.html#grouped-summaries-with-summarise">R for Data Science - Grouped summaries with <code>summarise()</code></a></li>
<li><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr <code>summarise()</code> reference</a></li>
</ul>
</div>
</div>
<div id="rearranging-data" class="section level2" number="5.9">
<h2>
<span class="header-section-number">5.9</span> Rearranging Data<a class="anchor" aria-label="anchor" href="#rearranging-data"><i class="fas fa-link"></i></a>
</h2>
<p>Sometimes the shape and format of our data is not the most convenient for
performing certain operations on it, even if it is <a href="data-wrangling.html#tidy-data">tidy</a>. Let’s say
we are considering the range of statistics that were computed for all of our
genes in the <code>gene_stats</code> tibble, and wanted to compute the average statistic
over all genes for both tests. Recall our tibble has separate columns for each
test:</p>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">gene</span>, <span class="op">~</span><span class="va">test1_stat</span>, <span class="op">~</span><span class="va">test1_p</span>, <span class="op">~</span><span class="va">test2_stat</span>, <span class="op">~</span><span class="va">test2_p</span>,</span>
<span>   <span class="st">"APOE"</span>,   <span class="fl">12.509293</span>,   <span class="fl">0.1032</span>,   <span class="fl">34.239521</span>,   <span class="fl">1.3e-5</span>,</span>
<span>  <span class="st">"HOXD1"</span>,    <span class="fl">4.399211</span>,   <span class="fl">0.6323</span>,   <span class="fl">16.332318</span>,   <span class="fl">0.0421</span>,</span>
<span>   <span class="st">"SNCA"</span>,   <span class="fl">45.748431</span>,   <span class="fl">4.2e-9</span>,    <span class="fl">0.757188</span>,   <span class="fl">0.9146</span>,</span>
<span><span class="op">)</span></span>
<span><span class="va">gene_stats</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   gene  test1_stat      test1_p test2_stat  test2_p
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 APOE       12.5  0.103            34.2   0.000013
## 2 HOXD1       4.40 0.632            16.3   0.0421  
## 3 SNCA       45.7  0.0000000042      0.757 0.915</code></pre>
<p>For convenience, we desire our output to be in table form, with one row per test
and the statistics for each test as columns. We could do this manually like so:</p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>   <span class="op">~</span><span class="va">test_name</span>, <span class="op">~</span><span class="va">min</span>, <span class="op">~</span><span class="va">mean</span>, <span class="op">~</span><span class="va">max</span>,</span>
<span>   <span class="st">"test1_stat"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">gene_stats</span><span class="op">$</span><span class="va">test1_stat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">gene_stats</span><span class="op">$</span><span class="va">test1_stat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">gene_stats</span><span class="op">$</span><span class="va">test1_stat</span><span class="op">)</span>,</span>
<span>   <span class="st">"test2_stat"</span>,  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">gene_stats</span><span class="op">$</span><span class="va">test2_stat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">gene_stats</span><span class="op">$</span><span class="va">test2_stat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">gene_stats</span><span class="op">$</span><span class="va">test2_stat</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##   test_name    min  mean   max
##   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 test1_stat 4.40   20.9  45.7
## 2 test2_stat 0.757  17.1  34.2</code></pre>
<p>This gets the job done, but is clearly very ugly, error prone, and would require
significant work if we later added more statistics columns.</p>
<p>Instead of typing out the values we desire manually, we can <em>pivot</em> our tibble
using the <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">tidyr::pivot_longer()</a></code> function, so that the column values are placed
in a new column and the corresponding values are placed in yet another column.
This process is illustrated in the following figure:</p>
<div class="float">
<img src="pivot_longer.png" alt="Pivot longer moves columns and values to two new columns"><div class="figcaption">Pivot longer moves columns and values to two new columns</div>
</div>
<p>In the figure, the original tibble has genes along rows and samples as columns.
When the sample columns are pivoted, the value of each column name is placed in
a new column named “Sample” and repeated for as many rows there are in the
tibble. A second new column “Value” is populated with the corresponding values
that were in each column. The gene associated with each value is preserved and
repeated vertically until all the table columns and values have been pivoted.
This process of pivoting transforms the tibble into so called “long” form.</p>
<p>Returning to our <code>gene_stats</code> example, we can apply some operations to the
tibble to easily perform the summarization we did above in a much more
expressive manner:</p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">long_gene_stats</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>  <span class="va">gene_stats</span>,</span>
<span>  <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"_stat"</span><span class="op">)</span>,</span>
<span>  names_to<span class="op">=</span><span class="st">"test"</span>,</span>
<span>  values_to<span class="op">=</span><span class="st">"stat"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">long_gene_stats</span></span></code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   gene       test1_p  test2_p test         stat
##   &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;
## 1 APOE  0.103        0.000013 test1_stat 12.5  
## 2 APOE  0.103        0.000013 test2_stat 34.2  
## 3 HOXD1 0.632        0.0421   test1_stat  4.40 
## 4 HOXD1 0.632        0.0421   test2_stat 16.3  
## 5 SNCA  0.0000000042 0.915    test1_stat 45.7  
## 6 SNCA  0.0000000042 0.915    test2_stat  0.757</code></pre>
<p>We see that now instead of having <code>X_stat</code> columns, the column names and their
values have been put into the <code>test</code> and <code>stat</code> columns, respectively. Now to
summarize the statistics for each test, we simply do a <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> on the
<code>test</code> column and compute summaries on the <code>stat</code> column:</p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">long_gene_stats</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">test</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">stat</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">stat</span><span class="op">)</span>, max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">stat</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##   test         min  mean   max
##   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 test1_stat 4.40   20.9  45.7
## 2 test2_stat 0.757  17.1  34.2</code></pre>
<p>You may verify that the numbers are identical in this pivoted tibble as the one
we manually created earlier. This pivoting method will produce the desired
output regardless of the number of tests we include the table, so long as the
column names end in <code>"_test"</code>.</p>
<div class="box note">
<p>The inverse of <code>pivot_longer()</code> is
<a href="https://tidyr.tidyverse.org/reference/pivot_wider.html"><code>pivot_wider()</code></a>. If
you have variables gathered in single columns like that produced by
<code>pivot_longer()</code> you can reverse the process with this function to create a
tibble with those variables as columns.</p>
</div>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/tidy-data.html#pivoting">Pivoting - R for Data Science</a></li>
<li><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html"><code>pivot_longer()</code> reference</a></li>
</ul>
</div>
</div>
<div id="relational-data" class="section level2" number="5.10">
<h2>
<span class="header-section-number">5.10</span> Relational Data<a class="anchor" aria-label="anchor" href="#relational-data"><i class="fas fa-link"></i></a>
</h2>
<p>As mentioned in our section on <a href="biology-bioinformatics.html#bio-data-types">types of biological data</a>, we
often need to combine different sources of data together to aid in
interpretation of our results. Below we redefine the tibble of gene statistics
from above to have properly capitalized gene symbols:</p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">gene</span>, <span class="op">~</span><span class="va">test1_stat</span>, <span class="op">~</span><span class="va">test1_p</span>, <span class="op">~</span><span class="va">test2_stat</span>, <span class="op">~</span><span class="va">test2_p</span>,</span>
<span>   <span class="st">"APOE"</span>,   <span class="fl">12.509293</span>,   <span class="fl">0.1032</span>,   <span class="fl">34.239521</span>,   <span class="fl">1.3e-5</span>,</span>
<span>  <span class="st">"HOXD1"</span>,    <span class="fl">4.399211</span>,   <span class="fl">0.6323</span>,   <span class="fl">16.332318</span>,   <span class="fl">0.0421</span>,</span>
<span>   <span class="st">"SNCA"</span>,   <span class="fl">45.748431</span>,   <span class="fl">4.2e-9</span>,    <span class="fl">0.757188</span>,   <span class="fl">0.9146</span>,</span>
<span><span class="op">)</span></span>
<span><span class="va">gene_stats</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   gene  test1_stat      test1_p test2_stat  test2_p
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 APOE       12.5  0.103            34.2   0.000013
## 2 HOXD1       4.40 0.632            16.3   0.0421  
## 3 SNCA       45.7  0.0000000042      0.757 0.915</code></pre>
<p>Our gene identifiers in this data frame are <a href="https://en.wikipedia.org/wiki/Gene_nomenclature#Symbol_and_name">gene
symbols</a> which,
while convenient for our human brains to remember, can change over time and have
many aliases (e.g. the APOE gene has also been called AD2, LDLCQ5, APO-E, and
ApoE4 as listed on its
<a href="https://www.genecards.org/cgi-bin/carddisp.pl?gene=APOE">genecard</a>). This can
make writing code that refers to a specific gene difficult, since there are so
many possible names to look for. Fortunately, there are alternative gene
identifier systems that do a better job of maintaining stable, consistent gene
identifiers, one of the most popular being <a href="https://www.ensembl.org/">Ensembl</a>.
Ensembl gene IDs always take the form <code>ENSGNNNNNNNNNNN</code> where <code>N</code>s are digits.
These IDs are much more stable and predictable than gene symbols, and are
preferable when working with genes in code.</p>
<p>We wish to add Ensembl IDs for the genes in our <code>gene_stats</code> result to the
tibble as a new column. Now suppose we have obtained another file with cross
referenced gene identifiers like the following:</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">symbol</span>,            <span class="op">~</span><span class="va">ENSGID</span>,                    <span class="op">~</span><span class="va">gene_name</span>,</span>
<span>     <span class="st">"APOE"</span>,  <span class="st">"ENSG00000130203"</span>,            <span class="st">"apolipoprotein E"</span>,</span>
<span>     <span class="st">"BRCA1"</span>,  <span class="st">"ENSG00000012048"</span>, <span class="st">"BRCA1 DNA repair associated"</span>,</span>
<span>    <span class="st">"HOXD1"</span>,  <span class="st">"ENSG00000128645"</span>,                 <span class="st">"homeobox D1"</span>,</span>
<span>     <span class="st">"SNCA"</span>,  <span class="st">"ENSG00000145335"</span>,             <span class="st">"synuclein alpha"</span>,</span>
<span><span class="op">)</span></span>
<span><span class="va">gene_map</span></span></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##   symbol ENSGID          gene_name                  
##   &lt;chr&gt;  &lt;chr&gt;           &lt;chr&gt;                      
## 1 APOE   ENSG00000130203 apolipoprotein E           
## 2 BRCA1  ENSG00000012048 BRCA1 DNA repair associated
## 3 HOXD1  ENSG00000128645 homeobox D1                
## 4 SNCA   ENSG00000145335 synuclein alpha</code></pre>
<p>Imagine that this file contains mappings for all ~60,000 genes in the human
genome. While it might be simple to look up our three genes in this file and
annotate manually, it is easier to ask <code>dplyr</code> to do it for us. We can do this
using the <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::left_join()</a></code> function which accepts two data frames and the
names of columns in each that share common values:</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>    x<span class="op">=</span><span class="va">gene_stats</span>,</span>
<span>    y<span class="op">=</span><span class="va">gene_map</span>,</span>
<span>    by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gene"</span> <span class="op">=</span> <span class="st">"symbol"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 7
##   gene  test1_stat      test1_p test2_stat  test2_p ENSGID          gene_name   
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;       
## 1 APOE       12.5  0.103            34.2   0.000013 ENSG00000130203 apolipoprot~
## 2 HOXD1       4.40 0.632            16.3   0.0421   ENSG00000128645 homeobox D1 
## 3 SNCA       45.7  0.0000000042      0.757 0.915    ENSG00000145335 synuclein a~</code></pre>
<p>Notice that the additional columns in <code>gene_map</code> that were not involved in the
join (i.e. <code>ENSG</code> and <code>gene_name</code>) are appended to the <code>gene_stats</code> tibble. If
we wanted to use pipes, we could implement the same join above as follows:</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">gene_map</span>,</span>
<span>  by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gene"</span> <span class="op">=</span> <span class="st">"symbol"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 7
##   gene  test1_stat      test1_p test2_stat  test2_p ENSGID          gene_name   
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;       
## 1 APOE       12.5  0.103            34.2   0.000013 ENSG00000130203 apolipoprot~
## 2 HOXD1       4.40 0.632            16.3   0.0421   ENSG00000128645 homeobox D1 
## 3 SNCA       45.7  0.0000000042      0.757 0.915    ENSG00000145335 synuclein a~</code></pre>
<p>Under the hood, the <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::left_join()</a></code> function took the values in
<code>gene_stats$gene</code> and looked for the corresponding row in <code>gene_map</code> with the
same value in in the <code>symbol</code> column. It then appends all the additional columns
of <code>gene_map</code> for the matching rows and returns the result. We have added the
identifier mapping we desired with only a few lines of code. And what’s more,
this code will work no matter how many genes we had in <code>gene_stats</code> as long as
<code>gene_map</code> contains a mapping value for the values in <code>gene_stats$gene</code>.</p>
<p>But what happens if we have genes in <code>gene_stats</code> that don’t exist in our
mapping? In the above example, we use a left join because we want to include
all the rows in <code>gene_stats</code> regardless of whether a mapping exists in
<code>gene_map</code>. In this case this was fine because all of our genes in <code>gene_stats</code>
had a corresponding row in the mapping. However, notice that in the mapping
there is an additional gene, <a href="https://en.wikipedia.org/wiki/BRCA1">BRCA1</a> that
is not in our gene statistics tibble. If we reverse the order of the join,
observe what happens:</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_map</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">gene_stats</span>,</span>
<span>  by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"symbol"</span> <span class="op">=</span> <span class="st">"gene"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 4 x 7
##   symbol ENSGID          gene_name       test1_stat  test1_p test2_stat  test2_p
##   &lt;chr&gt;  &lt;chr&gt;           &lt;chr&gt;                &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 APOE   ENSG00000130203 apolipoprotein~      12.5   1.03e-1     34.2    1.3 e-5
## 2 BRCA1  ENSG00000012048 BRCA1 DNA repa~      NA    NA           NA     NA      
## 3 HOXD1  ENSG00000128645 homeobox D1           4.40  6.32e-1     16.3    4.21e-2
## 4 SNCA   ENSG00000145335 synuclein alpha      45.7   4.2 e-9      0.757  9.15e-1</code></pre>
<p>Now the order of the rows is the same as in <code>gene_map</code>, and the columns for our
missing gene BRCA1 are filled with <code>NA</code>. This is the left join at work, where
the record from <code>gene_map</code> is included regardless of whether a corresponding
value was found in <code>gene_stats</code>.</p>
<p>There are additional types of joins besides left joins. Right joins are simply
the opposite of left joins:</p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_stats</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span></span>
<span>  <span class="va">gene_map</span>,</span>
<span>  by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gene"</span> <span class="op">=</span> <span class="st">"symbol"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 4 x 7
##   gene  test1_stat       test1_p test2_stat   test2_p ENSGID          gene_name 
##   &lt;chr&gt;      &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;     
## 1 APOE       12.5   0.103            34.2    0.000013 ENSG00000130203 apolipopr~
## 2 HOXD1       4.40  0.632            16.3    0.0421   ENSG00000128645 homeobox ~
## 3 SNCA       45.7   0.0000000042      0.757  0.915    ENSG00000145335 synuclein~
## 4 BRCA1      NA    NA                NA     NA        ENSG00000012048 BRCA1 DNA~</code></pre>
<p>The result is the same as the left join on <code>gene_map</code> except the order of the
resulting columns is different.</p>
<p>Inner joins return results for rows that have a match between the two tibbles.
Recall our left join on <code>gene_map</code> included BRCA1 even though it was not found
in <code>gene_stats</code>. An inner join will not include this row, because no match in
<code>gene_stats</code> was found:</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_map</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span></span>
<span>  <span class="va">gene_stats</span>,</span>
<span>  by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"symbol"</span> <span class="op">=</span> <span class="st">"gene"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 x 7
##   symbol ENSGID          gene_name        test1_stat  test1_p test2_stat test2_p
##   &lt;chr&gt;  &lt;chr&gt;           &lt;chr&gt;                 &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;
## 1 APOE   ENSG00000130203 apolipoprotein E      12.5   1.03e-1     34.2   1.3 e-5
## 2 HOXD1  ENSG00000128645 homeobox D1            4.40  6.32e-1     16.3   4.21e-2
## 3 SNCA   ENSG00000145335 synuclein alpha       45.7   4.2 e-9      0.757 9.15e-1</code></pre>
<p>One last type of join is the
<a href="https://dplyr.tidyverse.org/reference/mutate-joins.html"><code>dplyr::full_join()</code></a>
(also sometimes called an outer join). As you may expect, a full join will
return all rows from both tibbles whether a match in the other table was found
or not.</p>
<div id="dealing-with-multiple-matches" class="section level3" number="5.10.1">
<h3>
<span class="header-section-number">5.10.1</span> Dealing with multiple matches<a class="anchor" aria-label="anchor" href="#dealing-with-multiple-matches"><i class="fas fa-link"></i></a>
</h3>
<p>In the example above, there was a one-to-one relationship between the gene
symbols in both tibbles. This made the joined tibble tidy. However, when a
one-to-many relationship exists, i.e. one gene symbol in one tibble has multiple
rows in the other, this can lead to what appears to be duplicate rows in the
joined result. Due to the relative instability of gene symbols, it is very
common to have multiple Ensembl genes associated with a single gene symbol. The
following takes a gene mapping of Ensembl IDs to gene symbols and identifies
cases where multiple Ensembl IDs map to a single gene symbol:</p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_tsv</a></span><span class="op">(</span><span class="st">"mart_export.tsv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">`HGNC symbol`</span> <span class="op">!=</span> <span class="st">"NA"</span> <span class="op">&amp;</span> <span class="co"># many unstudied genes have Ensembl IDs but no official symbol</span></span>
<span>    <span class="va">`HGNC symbol`</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">`HGNC symbol`</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">`HGNC symbol`</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">`HGNC symbol`</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 7,268 x 3
##    `Gene stable ID` `HGNC symbol` `Gene name`                                
##    &lt;chr&gt;            &lt;chr&gt;         &lt;chr&gt;                                      
##  1 ENSG00000261846  AADACL2       arylacetamide deacetylase like 2           
##  2 ENSG00000197953  AADACL2       arylacetamide deacetylase like 2           
##  3 ENSG00000262466  AADACL2-AS1   &lt;NA&gt;                                       
##  4 ENSG00000242908  AADACL2-AS1   &lt;NA&gt;                                       
##  5 ENSG00000276072  AATF          apoptosis antagonizing transcription factor
##  6 ENSG00000275700  AATF          apoptosis antagonizing transcription factor
##  7 ENSG00000281173  ABCB10P1      &lt;NA&gt;                                       
##  8 ENSG00000280461  ABCB10P1      &lt;NA&gt;                                       
##  9 ENSG00000274099  ABCB10P1      &lt;NA&gt;                                       
## 10 ENSG00000282479  ABCB10P3      &lt;NA&gt;                                       
## # ... with 7,258 more rows</code></pre>
<p>There are over 7,000 Ensembl IDs that map to the same gene symbol as another
Ensembl ID. That is more than 10% of all Ensembl IDs. So now let’s create a new
<code>gene_stats</code> tibble with one of these gene symbols and join with the map to
see what happens:</p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_map</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_tsv</a></span><span class="op">(</span><span class="st">"mart_export.tsv"</span><span class="op">)</span></span>
<span><span class="va">gene_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">gene</span>, <span class="op">~</span><span class="va">test1_stat</span>, <span class="op">~</span><span class="va">test1_p</span>, <span class="op">~</span><span class="va">test2_stat</span>, <span class="op">~</span><span class="va">test2_p</span>,</span>
<span>   <span class="st">"APOE"</span>,   <span class="fl">12.509293</span>,   <span class="fl">0.1032</span>,   <span class="fl">34.239521</span>,   <span class="fl">1.3e-5</span>,</span>
<span>  <span class="st">"HOXD1"</span>,    <span class="fl">4.399211</span>,   <span class="fl">0.6323</span>,   <span class="fl">16.332318</span>,   <span class="fl">0.0421</span>,</span>
<span>   <span class="st">"SNCA"</span>,   <span class="fl">45.748431</span>,   <span class="fl">4.2e-9</span>,    <span class="fl">0.757188</span>,   <span class="fl">0.9146</span>,</span>
<span>  <span class="st">"DEAF1"</span>,    <span class="fl">0.000000</span>,      <span class="fl">1.0</span>,           <span class="fl">0</span>,      <span class="fl">1.0</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">gene_map</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gene"</span> <span class="op">=</span> <span class="st">"HGNC symbol"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gene_stats</span></span></code></pre></div>
<pre><code>## # A tibble: 5 x 7
##   gene  test1_stat      test1_p test2_stat  test2_p `Gene stable ID` `Gene name`
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;            &lt;chr&gt;      
## 1 APOE       12.5  0.103            34.2   0.000013 ENSG00000130203  apolipopro~
## 2 HOXD1       4.40 0.632            16.3   0.0421   ENSG00000128645  homeobox D1
## 3 SNCA       45.7  0.0000000042      0.757 0.915    ENSG00000145335  synuclein ~
## 4 DEAF1       0    1                 0     1        ENSG00000282712  DEAF1 tran~
## 5 DEAF1       0    1                 0     1        ENSG00000177030  DEAF1 tran~</code></pre>
<p>Notice how there are two rows for the DEAF1 gene that have identical values
except for the <code>Stable Gene ID</code> column. This is a very common problem when
mapping gene symbols to other gene identifiers and there is no general solution
to picking the “best” mapping, short of manually inspecting all of the
duplicates and choosing which one is the most appropriate yourself (which
obviously is a huge amount of work). However, we do desire to remove the
duplicated rows. In this case, since all the values besides the Ensembl ID are
the same, effectively it doesn’t matter which duplicate rows we eliminate. We
can do this using the <code><a href="https://rdrr.io/r/base/duplicated.html">duplicated()</a></code> function, which returns <code>TRUE</code> for all but
the first row of a set of duplicated values:</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">gene_stats</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 4 x 7
##   gene  test1_stat      test1_p test2_stat  test2_p `Gene stable ID` `Gene name`
##   &lt;chr&gt;      &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;            &lt;chr&gt;      
## 1 APOE       12.5  0.103            34.2   0.000013 ENSG00000130203  apolipopro~
## 2 HOXD1       4.40 0.632            16.3   0.0421   ENSG00000128645  homeobox D1
## 3 SNCA       45.7  0.0000000042      0.757 0.915    ENSG00000145335  synuclein ~
## 4 DEAF1       0    1                 0     1        ENSG00000282712  DEAF1 tran~</code></pre>
<p>However, in general, you must be careful about identifying these types of
one-to-many mapping issues and also about how you mitigate them.</p>
<div class="box readmore">
<ul>
<li><a href="https://r4ds.had.co.nz/relational-data.html">R for Data Science - Relational Data</a></li>
<li><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr - mutate joins</a></li>
</ul>
</div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="prog-basics.html"><span class="header-section-number">4</span> R Programming</a></div>
<div class="next"><a href="data-science.html"><span class="header-section-number">6</span> Data Science</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-wrangling"><span class="header-section-number">5</span> Data Wrangling</a></li>
<li><a class="nav-link" href="#the-tidyverse"><span class="header-section-number">5.1</span> The Tidyverse</a></li>
<li><a class="nav-link" href="#dw-basics"><span class="header-section-number">5.2</span> Tidyverse Basics</a></li>
<li><a class="nav-link" href="#importing-data"><span class="header-section-number">5.3</span> Importing Data</a></li>
<li><a class="nav-link" href="#data-tibble"><span class="header-section-number">5.4</span> The tibble</a></li>
<li><a class="nav-link" href="#tidy-data"><span class="header-section-number">5.5</span> Tidy Data</a></li>
<li><a class="nav-link" href="#pipes"><span class="header-section-number">5.6</span> pipes</a></li>
<li>
<a class="nav-link" href="#arranging-data"><span class="header-section-number">5.7</span> Arranging Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#dplyrmutate---create-new-columns-using-other-columns"><span class="header-section-number">5.7.1</span> dplyr::mutate() - Create new columns using other columns</a></li>
<li><a class="nav-link" href="#stringr---working-with-character-values"><span class="header-section-number">5.7.2</span> stringr - Working with character values</a></li>
<li><a class="nav-link" href="#dplyrselect---subset-columns-by-name"><span class="header-section-number">5.7.3</span> dplyr::select() - Subset Columns by Name</a></li>
<li><a class="nav-link" href="#dplyrfilter---pick-rows-out-of-a-data-set"><span class="header-section-number">5.7.4</span> dplyr::filter() - Pick rows out of a data set</a></li>
<li><a class="nav-link" href="#dplyrarrange---order-rows-based-on-their-values"><span class="header-section-number">5.7.5</span> dplyr::arrange() - Order rows based on their values</a></li>
<li><a class="nav-link" href="#putting-it-all-together"><span class="header-section-number">5.7.6</span> Putting it all together</a></li>
</ul>
</li>
<li><a class="nav-link" href="#grouping-data"><span class="header-section-number">5.8</span> Grouping Data</a></li>
<li><a class="nav-link" href="#rearranging-data"><span class="header-section-number">5.9</span> Rearranging Data</a></li>
<li>
<a class="nav-link" href="#relational-data"><span class="header-section-number">5.10</span> Relational Data</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#dealing-with-multiple-matches"><span class="header-section-number">5.10.1</span> Dealing with multiple matches</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>BF591 - R for Biological Sciences</strong>" was written by . </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
